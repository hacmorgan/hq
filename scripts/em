#!/usr/bin/env bash

# A simple script to open a given file in emacs,
# and detatch the process from the parent terminal 


source $( type -p bash-std )
BASH_STD_IGNORE_UNKNOWN_ARGS=1  # until positional args implemented


function prologue
{
    cat <<EOF 

${fmt_dim}${fmt_red}em - emacsclient wrapper${fmt_white}${fmt_normal}

${fmt_dim}Note: the filename must be the final argument. bash-std doesn't support positional arguments yet${fmt_normal}
EOF
}

function options
{
    cat <<EOF
--buffalo,-b; look for file (if any given) on buffalo
--enzo,-e; look for file (if any given) on enzo
--george,-g; look for file (if any given) on george
--terminal,-t; open file in the terminal, don't detach process from parent shell 
--via-george,-v; for remotes other than george, use george as a jump host
EOF
}

bash-std-application-init "$@" < <( options ) || die "failed"




function get_last_arg
{
    local args=( $@ )
    local num_args=${#args[@]}
    echo ${args[$(( num_args - 1 ))]}
}


function sanitize_inputs
{
    if (( options_george + options_buffalo + options_enzo > 1 )); then
        die "--george, --enzo and --buffalo are mutually exclusive"
    fi
}


function get_filename
{
    local last_arg=$( get_last_arg $@ )
    local file=""
    if [[ -z "$( grep '^-' <<< $last_arg )" ]]; then file="$last_arg"; fi
    if (( options_george )); then
        emacs_file_path="/ssh:$( where-is-george ):$file"
    elif (( options_buffalo )); then
        emacs_file_path="/ssh"
        if (( options_via_george )); then
            emacs_file_path+=":$( where-is-george )\|ssh"
        fi
        emacs_file_path+=":buffalo:$file"
    elif (( options_enzo )); then
        emacs_file_path="/ssh"
        if (( options_via_george )); then
            emacs_file_path+=":$( where-is-george )\|ssh"
        fi
        emacs_file_path+=":enzo:$file"
    else
        emacs_file_path="$file"
    fi
    echo $emacs_file_path
}





sanitize_inputs $@  # todo: see if this still breaks when given 2 files with "$@" instead of $@

file="$( get_filename $@ )"
command="emacsclient -a '' -c $file"
if (( options_terminal )); then
    command+=" -nw"
else
    command+=" &!"
fi
eval "$command"
